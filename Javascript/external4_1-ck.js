function getIndexedDB(){try{window.indexedDB||(window.indexedDB=window.moxIndexedDB||window.webkitIndexedDB);if(!window.indexedDB)return;return window.indexedDB}catch(a){return undefined}}function dbErrorHandler(a){dispError("Database error: "+a.target.errorCode)}function openDB(){var a=getIndexedDB();if(!DB){dispError("IndexedDB not supported.");return}try{var b=a.open("travelDB","demo travel database");b.onerror=function(a){errorDisplay("Failed to open IndexedDB database.")};b.onsuccess=function(a){db=b.result;db.onerror=dbErrorHandler;if(db.version!=dbVersion){var c=db.setVersion(dbVersion);c.onerror=function(a){alert("Version error: "+a.target.errorCodes)};c.onsuccess=function(a){alert("Creating the object store");var b=db.createObjectStore("otravel",{keyPath:"id",autoIncrement:!0});b.createIndex("traveler","ciTraveler",{unique:!1})}}}}catch(c){dispErroor("Browser supports IndexedDB but didn't open the database. ("+c.message+")")}}function retryDisp(){if(++retryCount>5){errorDisp("Cannot open the database after 5 retries");dispResults()}setTimeout("dispResults()",100)}function rowButtons(a,b){return'<form><input type="button" value="Edit" onClick="javascript:editGo('+a+')">'+'<input type="button" value="Delete" onClick="javascript:deleteGo('+a+", &quot;"+b+'&quot;)">'+"</form>"}function dispResults(){if(errorMessage){element("results").innerHTML=errorMessage;return}if(db){var a=new bwTable;a.setHeader(["traveler","Destination","Transportation",""]);var b=0,c=db.transaction(["oTravel"]).objectStore("oTravel"),d=c.indexTraveler("traveler");d.openCursor().onsuccess=function(c){var d=c.target.result;if(d){var e=d.value;a.addRow([e.traveler,e.destination,e.transportation,rowButtons(e.id,e.traveler)]);b++;d.continue()}else{element("rowCount").innerHTML=b;element("results").innerHTML=a.getTableHTML();element("travelForm").elements.travler.focus()}}}else retryDisp()}function dbGo(){if(errorMessage)return;var a=element("travelForm"),b=a.elements.inputAction.value,c=a.elements.traveler.value,d=a.elements.destination.value,e=a.elements.transportation.value,f=a.elements.key.value;switch(b){case"add":if(!(c||d||e))break;curRec={traveler:c,destination:d,transportation:e,ciTraveler:c.toLowerCase()};db.transaction("oTravel",IDBTransaction.READ_WRITE).objectStore("oTravel").add(curRec);break;case"update":if(!(c||d||e))break;curRec={traveler:c,destination:d,transportation:e,ciTraveler:c.toLowerCase()};var g=db.transaction("oTravel",IDBTransaction.READ_WRITE).objectStore("oTravel");g.delete(f).onsuccess=function(a){g.add(curRec)}}resetTravelForm();dispResults()}function editGo(a){db.transaction("oTravel").objectStore("oTravel").get(a).onsuccess=function(a){rec=a.target.result;if(rec){var b=element("travelForm");b.elements.traveler.value=rec.traveler;b.elements.destination.value=rec.destination;b.elements.transportation.value=rec.transportation;b.elements.goButton.value="Update";b.elements.inputKey.value="update";b.elements.key.value=rec.id;b.elements.traveler.focus();b.elements.traveler.select()}}}function deleteGo(a,b){if(confirm("Delete "+b+" (ID: "+a+")?")){db.transaction("oTravel",IDBTransaction.READ_WRITE).objectStore("oTravel").delete(a);resetTravelForm();dispResults()}}function resetTravelForm(){var a=element("travelForm");for(var b in["traveler","destination","transportation","key"])a.elements[b].value="";a.elements.inputAction.value="add";a.elements.goButton.value="Add"}function clearDB(){if(confirm("Clear the entire table?")){db.transaction("oTravel",IDBTransaction.READ_WRITE).objectStore("oTravel").clear();resetTravelForm();dispResults()}}function initDisp(){dispResults()}function getIndexedDB(){try{window.indexedDB||(window.indexedDB=window.mozIndexedDB||window.webkitIndexedDB);return window.indexedDB?window.indexedDB:undefined}catch(a){return undefined}}function dbErrorHandler(a){dispError("Database error: "+a.target.errorCode)}function openDB(){var a=getIndexedDB();if(!a){dispError("IndexedDB not supported.");return}try{var b=a.open("travelDB","demo travel database");b.onerror=function(a){errorDisplay("Failed to open IndexedDB database.")};b.onsuccess=function(a){db=b.result;db.onerror=dbErrorHandler;if(db.version!=dbVersion){var c=db.setVersion(dbVersion);c.onerror=function(a){alert("version error: "+a.target.errorCode)};c.onsuccess=function(a){alert("Creating the object store");var b=db.createObjectStore("oTravel",{keyPath:"id",autoIncrement:!0});b.createIndex("traveler","ciTraveler",{unique:!1})}}}}catch(c){dispError("Browser supports IndexedDB but didn't open the database. ("+c.message+")")}}function retryDisp(){if(++retryCount>5){errorDisp("Cannot open the database after 5 retries");dispResults()}setTimeout("dispResults()",100)}function rowButtons(a,b){return'<form><input type="button" value="Edit" onClick="javascript:editGo('+a+')"/>'+'<input type="button" value="Delete" onClick="javascript:deleteGo('+a+", &quot;"+b+'&quot;)"/></form>'}function dispResults(){if(errorMessage){element("results").innerHTML=errorMessage;return}if(db){var a=new bwTable;a.setHeader(["Traveler","Destination","Transportation",""]);var b=0,c=db.transaction(["oTravel"]).objectStore("oTravel"),d=c.index("traveler");d.openCursor().onsuccess=function(c){var d=c.target.result;if(d){var e=d.value;a.addRow([e.traveler,e.destination,e.transportation,rowButtons(e.id,e.traveler)]);b++;d.continue()}else{element("rowCount").innerHTML=b;element("results").innerHTML=a.getTableHTML();element("travelForm").elements.traveler.focus()}}}else retryDisp()}function dbGo(){if(errorMessage)return;var a=element("travelForm"),b=a.elements.inputAction.value,c=a.elements.traveler.value,d=a.elements.destination.value,e=a.elements.transportation.value,f=a.elements.key.value;switch(b){case"add":if(!(c||d||e))break;curRec={traveler:c,destination:d,transportation:e,ciTraveler:c.toLowerCase()};db.transaction(["oTravel"],IDBTransaction.READ_WRITE).objectStore("oTravel").add(curRec);break;case"update":if(!(c||d||e))break;curRec={traveler:c,destination:d,transportation:e,ciTraveler:c.toLowerCase()};var g=db.transaction("oTravel",IDBTransaction.READ_WRITE).objectStore("oTravel");g.delete(f).onsuccess=function(a){g.add(curRec)}}resetTravelForm();dispResults()}function editGo(a){db.transaction("oTravel").objectStore("oTravel").get(a).onsuccess=function(a){rec=a.target.result;if(rec){var b=element("travelForm");b.elements.traveler.value=rec.traveler;b.elements.destination.value=rec.destination;b.elements.transportation.value=rec.transportation;b.elements.goButton.value="Update";b.elements.inputAction.value="update";b.elements.key.value=rec.id;b.elements.traveler.focus();b.elements.traveler.select()}}}function deleteGo(a,b){if(confirm("Delete "+b+" (ID: "+a+")?")){db.transaction("oTravel",IDBTransaction.READ_WRITE).objectStore("oTravel").delete(a);resetTravelForm();dispResults()}}function resetTravelForm(){var a=element("travelForm");for(var b in["traveler","destination","transportation","key"])a.elements[b].value="";a.elements.inputAction.value="add";a.elements.goButton.value="Add"}function clearDB(){if(confirm("Clear the entire table?")){db.transaction("oTravel",IDBTransaction.READ_WRITE).objectStore("oTravel").clear();resetTravelForm();dispResults()}}function initDisp(){dispResults()}var db,dbVersion="1.0";openDB();var retryCount=0;window.onload=function(){initDisp()};var db,dbVersion="1.0";openDB();var retryCount=0;window.onload=function(){initDisp()};